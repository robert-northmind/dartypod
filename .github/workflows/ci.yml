name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

permissions:
  contents: read

jobs:
  analyze:
    name: Dart Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1.7.1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze project source
        run: dart analyze --fatal-infos

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1.7.1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      - name: Run tests
        run: dart test

  example:
    name: Run Example
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1.7.1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      - name: Run example
        run: dart run example/example.dart

  changelog:
    name: Changelog Check
    runs-on: ubuntu-latest
    # Only run on pull requests (not push to main)
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Check for skip-changelog label
        id: check-label
        run: |
          # Check if PR has the skip-changelog label
          if echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | grep -q 'skip-changelog'; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping changelog check due to 'skip-changelog' label"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check CHANGELOG has unreleased content
        if: steps.check-label.outputs.skip != 'true'
        run: |
          # Check if CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "❌ CHANGELOG.md not found"
            exit 1
          fi

          # Extract content between ## [Unreleased] and next ## heading
          unreleased_content=$(awk '/^## \[Unreleased\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md | grep -v '^[[:space:]]*$' | head -20)

          if [ -z "$unreleased_content" ]; then
            echo "❌ No content found under ## [Unreleased] section"
            echo ""
            echo "Please add your changes to the CHANGELOG.md under the ## [Unreleased] section."
            echo "If this PR doesn't require a changelog entry, add the 'skip-changelog' label."
            exit 1
          else
            echo "✅ Found unreleased content in CHANGELOG.md:"
            echo "$unreleased_content"
          fi
